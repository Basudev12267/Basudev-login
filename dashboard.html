<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Advanced Dashboard - Learn with Basudev">
    <meta name="author" content="Basudev Bhandari">
    <meta name="robots" content="index, follow">
    <title>Advanced Dashboard - Learn with Basudev</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #0a0e1b; color: #e0e0e0; padding: 20px; overflow-x: hidden; transition: background 0.5s, color 0.5s; }
        .container { max-width: 1400px; margin: 0 auto; background: rgba(255, 255, 255, 0.05); border-radius: 25px; border: 3px solid rgba(255, 165, 0, 0.2); padding: 40px; position: relative; box-shadow: 0 0 20px rgba(255, 165, 0, 0.1); }
        h1 { text-align: center; font-size: 3em; color: #ffa500; margin-bottom: 30px; animation: glowTitle 2s infinite alternate; }
        h1::after { content: 'BB'; position: absolute; bottom: -15px; right: -40px; font-size: 0.5em; color: #8a2be2; animation: spinBB 5s infinite linear; }
        .dashboard { display: none; flex-direction: column; gap: 30px; align-items: center; }
        .hamburger { position: fixed; top: 20px; left: 20px; font-size: 2em; color: #ffa500; cursor: pointer; z-index: 1100; }
        .nav-menu { position: fixed; top: 0; left: -300px; width: 300px; height: 100%; background: rgba(10, 14, 27, 0.95); border-right: 3px solid #ffa500; padding: 60px 20px 20px; transition: left 0.3s ease; z-index: 1000; }
        .nav-menu.active { left: 0; }
        .nav-menu ul { list-style: none; }
        .nav-menu li { margin: 20px 0; }
        .nav-menu a { color: #e0e0e0; text-decoration: none; font-size: 1.2em; display: block; padding: 10px; border-radius: 10px; transition: background 0.3s; }
        .nav-menu a:hover, .nav-menu a.active { background: rgba(255, 165, 0, 0.2); color: #ffa500; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 14, 27, 0.9); justify-content: center; align-items: center; z-index: 1000; }
        .loading-circle { width: 60px; height: 60px; border: 6px solid #ffa500; border-top: 6px solid #8a2be2; border-radius: 50%; animation: spin 1s linear infinite; }
        input, button, textarea, select { padding: 12px; border-radius: 25px; border: 2px solid #ffa500; background: rgba(10, 14, 27, 0.9); color: #e0e0e0; font-size: 1.1em; width: 250px; margin: 10px 0; transition: all 0.3s ease; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #8a2be2; }
        button { background: #ffa500; color: #0a0e1b; border: none; cursor: pointer; width: auto; padding: 12px 30px; }
        button:hover { background: #8a2be2; color: #fff; transform: scale(1.05); }
        button:disabled { background: #666; cursor: not-allowed; }
        .profile-section { text-align: center; margin-bottom: 30px; background: rgba(255, 165, 0, 0.1); padding: 20px; border-radius: 15px; width: 100%; max-width: 600px; }
        .avatar { width: 120px; height: 120px; border-radius: 50%; border: 3px solid #ffa500; object-fit: cover; margin-bottom: 15px; transition: transform 0.3s ease; }
        .avatar:hover { transform: rotate(5deg) scale(1.1); }
        .avatar-options { display: flex; gap: 15px; justify-content: center; margin-top: 15px; }
        .avatar-option { width: 60px; height: 60px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.3s ease; }
        .avatar-option:hover, .avatar-option.selected { border-color: #8a2be2; transform: scale(1.1); }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; width: 100%; }
        .card { background: rgba(10, 14, 27, 0.95); border-radius: 20px; padding: 25px; border: 2px solid #ffa500; transition: all 0.3s ease; position: relative; }
        .card:hover { border-color: #8a2be2; transform: translateY(-5px); box-shadow: 0 0 15px rgba(138, 43, 226, 0.3); }
        .card h2 { font-size: 1.8em; color: #fff; background: linear-gradient(45deg, #ffa500, #8a2be2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 15px; }
        .card p { font-size: 1.1em; color: #d1d8e0; }
        .progress-bar { height: 25px; background: rgba(255, 255, 255, 0.1); border-radius: 12px; overflow: hidden; margin-top: 15px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #ffa500, #8a2be2); width: 0; transition: width 0.5s ease; }
        .task-list { list-style: none; padding: 0; }
        .task-list li { display: flex; align-items: center; gap: 15px; margin: 15px 0; padding: 10px; background: rgba(255, 165, 0, 0.05); border-radius: 10px; transition: background 0.3s; }
        .task-list li:hover { background: rgba(255, 165, 0, 0.1); }
        .task-list input[type="checkbox"] { width: 25px; height: 25px; accent-color: #ffa500; }
        .streak-circle { width: 60px; height: 60px; background: radial-gradient(circle, #ffa500, #8a2be2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5em; color: #0a0e1b; margin: 10px auto; box-shadow: 0 0 10px rgba(255, 165, 0, 0.5); }
        .badges { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .badge { width: 40px; height: 40px; background: #ffa500; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2em; color: #0a0e1b; opacity: 0.3; transition: opacity 0.3s ease, transform 0.3s ease; }
        .badge.active { opacity: 1; transform: scale(1.1); }
        footer { text-align: center; padding: 25px; font-size: 1em; color: #d1d8e0; background: rgba(0, 0, 0, 0.8); border-top: 3px solid rgba(255, 165, 0, 0.2); margin-top: 25px; }
        .notes-section, .challenge-section, .chat-section, .resources-section, .goals-section, .quiz-section, .settings-section, .video-call-section, .ebook-library-section, .youtube-section { width: 100%; max-width: 600px; }
        textarea { width: 100%; height: 100px; resize: vertical; background: rgba(255, 255, 255, 0.05); }
        .leaderboard { list-style: none; padding: 0; }
        .leaderboard li { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255, 165, 0, 0.2); transition: background 0.3s; }
        .leaderboard li:hover { background: rgba(255, 165, 0, 0.1); }
        .chart-container { width: 100%; max-width: 600px; margin: 20px 0; }
        canvas { width: 100% !important; height: 300px !important; }
        .challenge-item { padding: 15px; background: rgba(255, 165, 0, 0.05); border-radius: 10px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .challenge-item.completed { background: rgba(138, 43, 226, 0.1); }
        .points { font-size: 1.2em; color: #ffa500; margin: 10px 0; }
        .chat-messages { height: 200px; overflow-y: auto; background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 10px; margin-bottom: 10px; }
        .chat-message { padding: 8px; margin: 5px 0; background: rgba(255, 165, 0, 0.1); border-radius: 8px; display: flex; justify-content: space-between; }
        .chat-message.self { background: rgba(138, 43, 226, 0.1); text-align: right; }
        .resource-list, .goal-list { list-style: none; padding: 0; }
        .resource-item, .goal-item { padding: 10px; background: rgba(255, 165, 0, 0.05); border-radius: 10px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .resource-item a { color: #ffa500; text-decoration: none; }
        .resource-item a:hover { color: #8a2be2; }
        .goal-item.completed { background: rgba(138, 43, 226, 0.1); }
        .quiz-section .question { margin: 15px 0; }
        .quiz-section .options { display: flex; flex-direction: column; gap: 10px; }
        .settings-section form { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        #settingsMessage { color: #ffa500; margin-top: 10px; }
        #settingsMessage.error { color: red; }
        .video-call-section .video-container { display: flex; justify-content: space-around; margin: 20px 0; gap: 20px; }
        .video-call-section video { width: 45%; max-width: 280px; border-radius: 15px; border: 2px solid #ffa500; background: #000; }
        #callStatus { font-size: 1.2em; margin: 10px 0; color: #ffa500; }
        #myRoomId { font-size: 1.1em; color: #8a2be2; margin: 10px 0; }
        .ebook-library-section, .youtube-section { width: 100%; max-width: 800px; background: linear-gradient(135deg, rgba(255, 165, 0, 0.1), rgba(138, 43, 226, 0.1)); border: 2px solid #ffa500; border-radius: 20px; padding: 25px; animation: fadeIn 0.5s ease; }
        .ebook-search, .youtube-search { display: flex; gap: 15px; margin-bottom: 20px; }
        .ebook-search input, .youtube-search input { width: 70%; background: rgba(255, 255, 255, 0.05); }
        .ebook-search button, .youtube-search button { width: 30%; }
        .ebook-list, .favorite-books, .youtube-list, .favorite-videos { max-height: 400px; overflow-y: auto; padding: 10px; }
        .book-item, .video-item { display: flex; align-items: center; background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 15px; margin: 10px 0; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .book-item:hover, .video-item:hover { transform: translateY(-5px); box-shadow: 0 0 15px rgba(138, 43, 226, 0.3); }
        .book-item img { width: 80px; height: 120px; border-radius: 10px; margin-right: 15px; object-fit: cover; }
        .video-item img { width: 120px; height: 90px; border-radius: 10px; margin-right: 15px; object-fit: cover; }
        .book-info, .video-info { flex: 1; }
        .book-info h3, .video-info h3 { color: #ffa500; font-size: 1.2em; margin-bottom: 5px; }
        .book-info p { font-size: 0.9em; color: #d1d8e0; margin: 5px 0; }
        .book-item button, .video-item button { background: #8a2be2; padding: 8px 15px; font-size: 0.9em; }
        .favorite-books h2, .favorite-videos h2 { margin-top: 20px; }
        #ebookMessage, #youtubeMessage { color: #ffa500; margin-top: 10px; font-size: 1.1em; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes glowTitle { 0% { text-shadow: 0 0 10px #ffa500; } 100% { text-shadow: 0 0 20px #ffa500, 0 0 40px #8a2be2; } }
        @keyframes spinBB { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="hamburger" onclick="toggleMenu()">☰</div>
    <div class="nav-menu" id="navMenu">
        <ul>
            <li><a href="#" onclick="showSection('profile')" class="active">Profile</a></li>
            <li><a href="#" onclick="showSection('progress')">Progress</a></li>
            <li><a href="#" onclick="showSection('stats')">Stats</a></li>
            <li><a href="#" onclick="showSection('notes')">Notes</a></li>
            <li><a href="#" onclick="showSection('challenges')">Challenges</a></li>
            <li><a href="#" onclick="showSection('leaderboard')">Leaderboard</a></li>
            <li><a href="#" onclick="showSection('chat')">Community Chat</a></li>
            <li><a href="#" onclick="showSection('resources')">Resources</a></li>
            <li><a href="#" onclick="showSection('goals')">Goals</a></li>
            <li><a href="#" onclick="showSection('quiz')">Quiz</a></li>
            <li><a href="#" onclick="showSection('videoCall')">Video Call</a></li>
            <li><a href="#" onclick="showSection('ebookLibrary')">E-Book Library</a></li>
            <li><a href="#" onclick="showSection('youtube')">YouTube</a></li>
            <li><a href="#" onclick="showSection('settings')">Settings</a></li>
            <li><a href="#" onclick="logout()">Logout</a></li>
        </ul>
    </div>
    <div class="container">
        <h1>Dashboard - Learn with Basudev</h1>
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-circle"></div>
        </div>
        <div class="dashboard" id="dashboard">
            <div class="profile-section" id="profileSection">
                <img src="" alt="Avatar" class="avatar" id="avatar">
                <input type="file" id="photoUpload" accept="image/*" onchange="uploadPhoto()" style="display: none;">
                <button onclick="document.getElementById('photoUpload').click()">Upload Photo</button>
                <p style="color: #d1d8e0; margin: 10px 0;">Or pick an avatar:</p>
                <div class="avatar-options" id="avatarOptions">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAdElEQVR42u3Q0QnAIAwF0G/AO7iDCxgQ64G7QkJkJAmCkN/fX3IBAAAAnHNg+wAAAACAMw5s/QAAAAAAgDMObP0AAAAAAIAzDmz9AAAAAACAMw5s/QAAAAAAgDMObP0AAAAAAIAzDmz9AAAAAACAMw5s/QAAAAAAgL8dFrpJHHv5nS8AAAAASUVORK5CYII=" class="avatar-option" onclick="setAvatar(this.src)">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAbUlEQVR42u3Q0QnAIAwE0O/AO7iDCxgQ64G7QkJkJAmCkN/fX3IBAAAAnHNg+wAAAACAMw5s/QAAAAAAgDMObP0AAAAAAIAzDmz9AAAAAACAMw5s/QAAAAAAgDMObP0AAAAAAIAzDmz9AAAAAACAf1cdFrpJHHyCUnUAAAAASUVORK5CYII=" class="avatar-option" onclick="setAvatar(this.src)">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAbElEQVR42u3Q0QnAIAwE0O/AO7iDCxgQ64G7QkJkJAmCkN/fX3IBAAAAnHNg+wAAAACAMw5s/QAAAAAAgDMObP0AAAAAAIAzDmz9AAAAAACAMw5s/QAAAAAAgDMObP0AAAAAAIAzDmz9AAAAAACAf1sdFrpJHHx2mG0AAAAASUVORK5CYII=" class="avatar-option" onclick="setAvatar(this.src)">
                </div>
                <p class="points">Points: <span id="userPoints">0</span></p>
                <input type="text" id="bio" placeholder="Add a bio...">
                <button onclick="saveBio()">Save Bio</button>
                <p id="userBio"></p>
                <select id="themeSelect" onchange="changeTheme()">
                    <option value="dark">Dark Theme</option>
                    <option value="light">Light Theme</option>
                    <option value="cosmic">Cosmic Theme</option>
                </select>
            </div>
            <div class="dashboard-grid" id="dashboardGrid">
                <div class="card" id="welcomeCard">
                    <h2>Welcome, <span id="userNameDisplay"></span>!</h2>
                    <p>Hey there! It’s Basudev—your guide! Start your learning journey now!</p>
                </div>
                <div class="card" id="progressCard" style="display: none;">
                    <h2>Learning Progress</h2>
                    <p>Tasks Done: <span id="tasksDone">0</span>/<span id="totalTasks">7</span></p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <ul class="task-list" id="taskList">
                        <li><input type="checkbox" onchange="updateProgress()"> Learn HTML Basics</li>
                        <li><input type="checkbox" onchange="updateProgress()"> Style with CSS</li>
                        <li><input type="checkbox" onchange="updateProgress()"> Code JS Functions</li>
                        <li><input type="checkbox" onchange="updateProgress()"> Build a Project</li>
                        <li><input type="checkbox" onchange="updateProgress()"> Take My Quiz</li>
                        <li><input type="checkbox" onchange="updateProgress()"> Read My Blog</li>
                        <li><input type="checkbox" onchange="updateProgress()"> Join Community</li>
                    </ul>
                </div>
                <div class="card chart-container" id="chartCard" style="display: none;">
                    <h2>Progress Chart</h2>
                    <canvas id="progressChart"></canvas>
                </div>
                <div class="card" id="statsCard" style="display: none;">
                    <h2>Stats & Streaks</h2>
                    <p>Last Login: <span id="lastLogin">Just Now</span></p>
                    <p>Days Active: <span id="daysActive">1</span></p>
                    <p>Streak: <span id="streakCount">0</span> days</p>
                    <div class="streak-circle" id="streakCircle">0</div>
                    <p>Achievements:</p>
                    <div class="badges" id="badges">
                        <div class="badge" id="badge1">🚀</div>
                        <div class="badge" id="badge2">⭐</div>
                        <div class="badge" id="badge3">🏆</div>
                        <div class="badge" id="badge4">🔥</div>
                    </div>
                </div>
                <div class="card notes-section" id="notesCard" style="display: none;">
                    <h2>Notes</h2>
                    <textarea id="notes" placeholder="Jot down your thoughts..."></textarea>
                    <button onclick="saveNotes()">Save</button>
                </div>
                <div class="card challenge-section" id="challengesCard" style="display: none;">
                    <h2>Challenges</h2>
                    <div class="challenge-item" id="challenge1">
                        <span>Complete a task</span>
                        <button onclick="completeChallenge('challenge1', 10)">Claim (10 pts)</button>
                    </div>
                    <div class="challenge-item" id="challenge2">
                        <span>Login 3 days</span>
                        <button onclick="completeChallenge('challenge2', 20)">Claim (20 pts)</button>
                    </div>
                    <div class="challenge-item" id="challenge3">
                        <span>Share a note</span>
                        <button onclick="completeChallenge('challenge3', 15)">Claim (15 pts)</button>
                    </div>
                </div>
                <div class="card" id="leaderboardCard" style="display: none;">
                    <h2>Leaderboard</h2>
                    <ul class="leaderboard" id="leaderboard"></ul>
                </div>
                <div class="card chat-section" id="chatCard" style="display: none;">
                    <h2>Community Chat</h2>
                    <div class="chat-messages" id="chatMessages"></div>
                    <input type="text" id="chatInput" placeholder="Type a message...">
                    <button onclick="sendChatMessage()">Send</button>
                </div>
                <div class="card resources-section" id="resourcesCard" style="display: none;">
                    <h2>Resources</h2>
                    <ul class="resource-list" id="resourceList">
                        <li class="resource-item"><span>HTML Basics</span><a href="https://www.w3schools.com/html/" target="_blank">Visit</a></li>
                        <li class="resource-item"><span>CSS Tutorial</span><a href="https://www.w3schools.com/css/" target="_blank">Visit</a></li>
                        <li class="resource-item"><span>JS Guide</span><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript" target="_blank">Visit</a></li>
                    </ul>
                    <input type="text" id="resourceTitle" placeholder="Resource Title">
                    <input type="url" id="resourceUrl" placeholder="Resource URL">
                    <button onclick="addResource()">Add</button>
                </div>
                <div class="card goals-section" id="goalsCard" style="display: none;">
                    <h2>Goals</h2>
                    <ul class="goal-list" id="goalList"></ul>
                    <input type="text" id="goalInput" placeholder="New goal...">
                    <button onclick="addGoal()">Add</button>
                </div>
                <div class="card quiz-section" id="quizCard" style="display: none;">
                    <h2>Quiz</h2>
                    <div class="question" id="quizQuestion"></div>
                    <div class="options" id="quizOptions"></div>
                    <button onclick="submitQuiz()">Submit</button>
                    <p id="quizResult"></p>
                </div>
                <div class="card video-call-section" id="videoCallCard" style="display: none;">
                    <h2>Video Call</h2>
                    <p id="callStatus">Your Room ID is ready.</p>
                    <p id="myRoomId">My Room ID: <span id="userRoomId"></span></p>
                    <div class="video-container">
                        <video id="localVideo" autoplay playsinline muted></video>
                        <video id="remoteVideo" autoplay playsinline></video>
                    </div>
                    <input type="text" id="remoteRoomId" placeholder="Friend's Room ID">
                    <button id="callBtn" onclick="startCall()">Call</button>
                    <button id="hangupBtn" onclick="hangUp()" disabled>Hang Up</button>
                </div>
                <div class="card ebook-library-section" id="ebookLibraryCard" style="display: none;">
                    <h2>E-Book Library</h2>
                    <div class="ebook-search">
                        <input type="text" id="bookSearch" placeholder="Search books...">
                        <button onclick="searchBooks()">Search</button>
                    </div>
                    <div class="ebook-list" id="bookList"></div>
                    <h2>Favorite Books</h2>
                    <div class="favorite-books" id="favoriteBooks"></div>
                    <p id="ebookMessage"></p>
                </div>
                <div class="card youtube-section" id="youtubeCard" style="display: none;">
                    <h2>YouTube</h2>
                    <div class="youtube-search">
                        <input type="text" id="youtubeSearch" placeholder="Search videos...">
                        <button onclick="searchYouTube()">Search</button>
                    </div>
                    <div class="youtube-list" id="youtubeList"></div>
                    <h2>Favorite Videos</h2>
                    <div class="favorite-videos" id="favoriteVideos"></div>
                    <p id="youtubeMessage"></p>
                </div>
                <div class="card settings-section" id="settingsCard" style="display: none;">
                    <h2>Settings</h2>
                    <form id="changeEmailForm">
                        <input type="email" id="newEmail" placeholder="New Email">
                        <input type="password" id="emailPassword" placeholder="Password">
                        <button type="button" onclick="changeEmail()">Change Email</button>
                    </form>
                    <form id="changePasswordForm">
                        <input type="password" id="currentPassword" placeholder="Current Password">
                        <input type="password" id="newPassword" placeholder="New Password">
                        <button type="button" onclick="changePassword()">Change Password</button>
                    </form>
                    <form id="updateUsernameForm">
                        <input type="text" id="newUsername" placeholder="New Username">
                        <button type="button" onclick="updateUsername()">Update Username</button>
                    </form>
                    <button onclick="deleteAccount()" style="background: #ff4444; margin-top: 20px;">Delete Account</button>
                    <p id="settingsMessage"></p>
                </div>
            </div>
        </div>
    </div>
    <footer>© 2025 Learn with Basudev | Crafted by Basudev Bhandari</footer>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateEmail, updatePassword, reauthenticateWithCredential, EmailAuthProvider, deleteUser } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, setDoc, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBBTbh6AcFhQlgXDXeSbwVxjpqv8ylrd54",
            authDomain: "login-a499c.firebaseapp.com",
            projectId: "login-a499c",
            storageBucket: "login-a499c.firebasestorage.app",
            messagingSenderId: "565328874509",
            appId: "1:565328874509:web:85d6124f15e3fa8e4b1944",
            measurementId: "G-CR2TNZ0R1F"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }, { urls: "stun:stun1.l.google.com:19302" }] };
        const GOOGLE_BOOKS_API_KEY = "AIzaSyB6D1V8GvGLSoAE92n-w_lhR_aGx2wDwiY";
        const YOUTUBE_API_KEY = "AIzaSyCQc5R6kCeiDCSvXXu2EMjOgcSaeKit7N4";
        const defaultAvatar = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAdElEQVR42u3Q0QnAIAwF0G/AO7iDCxgQ64G7QkJkJAmCkN/fX3IBAAAAnHNg+wAAAACAMw5s/QAAAAAAgDMObP0AAAAAAIAzDmz9AAAAAACAMw5s/QAAAAAAgDMObP0AAAAAAIAzDmz9AAAAAACAMw5s/QAAAAAAgL8dFrpJHHv5nS8AAAAASUVORK5CYII=";
        let userData = {};
        let progressChart;
        let isRedirecting = false;
        let currentSection = 'profile';
        let localStream;
        let remoteStream;
        let peerConnection;
        let isVideoCallActive = false;

        onAuthStateChanged(auth, (user) => {
            if (isRedirecting) return;
            if (user) {
                showLoading();
                loadUserData(user).then(() => {
                    setTimeout(() => {
                        hideLoading();
                        showDashboard();
                        loadLeaderboard();
                        loadChatMessages();
                        initializeChart();
                        checkDailyLogin();
                        loadGoals();
                        loadQuiz();
                    }, 1000);
                }).catch(error => {
                    console.error("Error loading user data:", error);
                    redirectToLogin();
                });
            } else {
                redirectToLogin();
            }
        });

        function redirectToLogin() {
            if (!isRedirecting) {
                isRedirecting = true;
                window.location.href = "index.html";
            }
        }

        window.logout = function() {
            showLoading();
            signOut(auth).then(() => {
                setTimeout(() => {
                    hideLoading();
                    localStorage.removeItem('basudevUser');
                    userData = {};
                    redirectToLogin();
                }, 1000);
            }).catch(error => {
                hideLoading();
                console.error("Logout error:", error.message);
            });
        };

        async function loadUserData(user) {
            const docSnap = await getDoc(doc(db, 'users', user.uid));
            if (docSnap.exists()) {
                userData = docSnap.data();
                userData.name = userData.username || "User";
                userData.notes = userData.notes || "";
                userData.points = userData.points || 0;
                userData.challenges = userData.challenges || {};
                userData.lastLoginDate = userData.lastLoginDate || null;
                userData.bio = userData.bio || "";
                userData.goals = userData.goals || [];
                userData.roomId = userData.roomId || Math.random().toString(36).substring(2, 10);
                userData.favoriteBooks = userData.favoriteBooks || [];
                userData.favoriteVideos = userData.favoriteVideos || [];
                userData.progress = userData.progress || Array(7).fill(false);
                userData.achievements = userData.achievements || { badge1: false, badge2: false, badge3: false, badge4: false };
                userData.loginCount = userData.loginCount || 0;
                userData.streak = userData.streak || 0;
                localStorage.setItem('basudevUser', JSON.stringify(userData));
                await updateDoc(doc(db, 'users', user.uid), { 
                    roomId: userData.roomId, 
                    favoriteBooks: userData.favoriteBooks,
                    favoriteVideos: userData.favoriteVideos,
                    progress: userData.progress,
                    achievements: userData.achievements,
                    loginCount: userData.loginCount,
                    streak: userData.streak
                });
            } else {
                throw new Error("No user data found in Firestore");
            }
        }

        function showDashboard() {
            document.getElementById('dashboard').style.display = 'flex';
            showSection(currentSection);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        window.toggleMenu = function() {
            document.getElementById('navMenu').classList.toggle('active');
        };

        window.showSection = function(section) {
            currentSection = section;
            const sections = ['profile', 'progress', 'stats', 'notes', 'challenges', 'leaderboard', 'chat', 'resources', 'goals', 'quiz', 'videoCall', 'ebookLibrary', 'youtube', 'settings'];
            sections.forEach(s => {
                const card = document.getElementById(`${s}Card`);
                if (card) card.style.display = s === section ? 'block' : 'none';
            });
            document.getElementById('welcomeCard').style.display = section === 'profile' ? 'block' : 'none';
            document.getElementById('profileSection').style.display = section === 'profile' ? 'block' : 'none';
            document.querySelectorAll('.nav-menu a').forEach(a => a.classList.remove('active'));
            const activeLink = document.querySelector(`.nav-menu a[onclick="showSection('${section}')"]`);
            if (activeLink) activeLink.classList.add('active');

            if (section === 'videoCall' && !isVideoCallActive) {
                initVideoCall();
                isVideoCallActive = true;
            } else if (section !== 'videoCall' && isVideoCallActive) {
                hangUp();
                isVideoCallActive = false;
            }

            if (section === 'ebookLibrary') loadFavoriteBooks();
            if (section === 'youtube') loadFavoriteVideos();

            toggleMenu();
        };

        window.uploadPhoto = function() {
            const file = document.getElementById('photoUpload').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    userData.avatar = e.target.result;
                    localStorage.setItem('basudevUser', JSON.stringify(userData));
                    document.getElementById('avatar').src = userData.avatar;
                    updateDoc(doc(db, 'users', auth.currentUser.uid), { avatar: userData.avatar });
                };
                reader.readAsDataURL(file);
            }
        };

        window.setAvatar = function(src) {
            userData.avatar = src;
            localStorage.setItem('basudevUser', JSON.stringify(userData));
            document.getElementById('avatar').src = userData.avatar;
            updateDoc(doc(db, 'users', auth.currentUser.uid), { avatar: src });
            document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
            event.target.classList.add('selected');
        };

        window.saveBio = function() {
            userData.bio = document.getElementById('bio').value;
            localStorage.setItem('basudevUser', JSON.stringify(userData));
            updateDoc(doc(db, 'users', auth.currentUser.uid), { bio: userData.bio }).then(() => {
                document.getElementById('userBio').textContent = userData.bio;
                document.getElementById('bio').value = '';
            }).catch(error => console.error("Error saving bio:", error));
        };

        function loadProgress() {
            const tasks = document.querySelectorAll('#taskList input');
            tasks.forEach((task, i) => task.checked = userData.progress[i]);
            updateProgress();
        }

        function updateProgress() {
            const tasks = document.querySelectorAll('#taskList input');
            let completed = 0;
            tasks.forEach((task, i) => {
                if (task.checked) completed++;
                userData.progress[i] = task.checked;
            });
            localStorage.setItem('basudevUser', JSON.stringify(userData));
            updateDoc(doc(db, 'users', auth.currentUser.uid), { progress: userData.progress });
            document.getElementById('tasksDone').textContent = completed;
            document.getElementById('totalTasks').textContent = tasks.length;
            document.getElementById('progressFill').style.width = `${(completed / tasks.length) * 100}%`;
            updateAchievements();
            updateChart(completed, tasks.length - completed);
            if (completed > 0) completeChallenge('challenge1', 0);
        }

        function updateAchievements() {
            const completed = parseInt(document.getElementById('tasksDone').textContent);
            const total = parseInt(document.getElementById('totalTasks').textContent);
            const streak = userData.streak;
            userData.achievements.badge1 = completed >= 1;
            userData.achievements.badge2 = completed >= total / 2;
            userData.achievements.badge3 = completed === total;
            userData.achievements.badge4 = streak >= 3;
            document.getElementById('badge1').classList.toggle('active', userData.achievements.badge1);
            document.getElementById('badge2').classList.toggle('active', userData.achievements.badge2);
            document.getElementById('badge3').classList.toggle('active', userData.achievements.badge3);
            document.getElementById('badge4').classList.toggle('active', userData.achievements.badge4);
            localStorage.setItem('basudevUser', JSON.stringify(userData));
            updateDoc(doc(db, 'users', auth.currentUser.uid), { achievements: userData.achievements });
        }

        window.saveNotes = function() {
            userData.notes = document.getElementById('notes').value;
            localStorage.setItem('basudevUser', JSON.stringify(userData));
            updateDoc(doc(db, 'users', auth.currentUser.uid), { notes: userData.notes });
        };

        async function loadLeaderboard() {
            const leaderboardList = document.getElementById('leaderboard');
            leaderboardList.innerHTML = '';
            const querySnapshot = await getDocs(collection(db, 'users'));
            const users = [];
            querySnapshot.forEach(doc => {
                const data = doc.data();
                users.push({ name: data.username, completed: (data.progress || []).filter(Boolean).length });
            });
            users.sort((a, b) => b.completed - a.completed);
            users.slice(0, 5).forEach((user, index) => {
                const li = document.createElement('li');
                li.innerHTML = `${index + 1}. ${user.name} <span>${user.completed}/7</span>`;
                leaderboardList.appendChild(li);
            });
        }

        function initializeChart(completed = 0, remaining = 7) {
            const ctx = document.getElementById('progressChart').getContext('2d');
            if (progressChart) progressChart.destroy();
            progressChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Remaining'],
                    datasets: [{ data: [completed, remaining], backgroundColor: ['#ffa500', '#8a2be2'], borderColor: ['#0a0e1b', '#0a0e1b'], borderWidth: 2 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: '#e0e0e0' } }, title: { display: true, text: 'Task Progress', color: '#ffa500', font: { size: 18 } } } }
            });
        }

        function updateChart(completed, remaining) {
            progressChart.data.datasets[0].data = [completed, remaining];
            progressChart.update();
        }

        window.completeChallenge = function(challengeId, points) {
            if (!userData.challenges[challengeId]) {
                userData.challenges[challengeId] = true;
                userData.points += points;
                localStorage.setItem('basudevUser', JSON.stringify(userData));
                updateDoc(doc(db, 'users', auth.currentUser.uid), { challenges: userData.challenges, points: userData.points });
                document.getElementById('userPoints').textContent = userData.points;
                const challengeItem = document.getElementById(challengeId);
                challengeItem.classList.add('completed');
                challengeItem.querySelector('button').disabled = true;
                challengeItem.querySelector('button').textContent = 'Completed';
            }
        };

        function updateChallengeStatus() {
            ['challenge1', 'challenge2', 'challenge3'].forEach(id => {
                const item = document.getElementById(id);
                if (userData.challenges[id]) {
                    item.classList.add('completed');
                    item.querySelector('button').disabled = true;
                    item.querySelector('button').textContent = 'Completed';
                }
            });
            const today = new Date().toDateString();
            if (userData.lastLoginDate === today) completeChallenge('challenge1', 0);
            if (userData.streak >= 3) completeChallenge('challenge2', 0);
        }

        async function checkDailyLogin() {
            const today = new Date().toDateString();
            if (userData.lastLoginDate !== today) {
                userData.loginCount++;
                const lastDate = new Date(userData.lastLoginDate || new Date());
                const todayDate = new Date(today);
                const diffDays = (todayDate - lastDate) / (1000 * 60 * 60 * 24);
                userData.streak = diffDays === 1 ? userData.streak + 1 : 1;
                userData.lastLoginDate = today;
                userData.lastLogin = new Date().toLocaleString();
                userData.points += 5;
                localStorage.setItem('basudevUser', JSON.stringify(userData));
                await updateDoc(doc(db, 'users', auth.currentUser.uid), {
                    loginCount: userData.loginCount,
                    streak: userData.streak,
                    lastLoginDate: userData.lastLoginDate,
                    lastLogin: userData.lastLogin,
                    points: userData.points
                });
                document.getElementById('daysActive').textContent = userData.loginCount;
                document.getElementById('streakCount').textContent = userData.streak;
                document.getElementById('streakCircle').textContent = userData.streak;
                document.getElementById('lastLogin').textContent = userData.lastLogin;
                document.getElementById('userPoints').textContent = userData.points;
            }
            updateChallengeStatus();
        }

        window.sendChatMessage = async function() {
            const message = document.getElementById('chatInput').value.trim();
            if (message) {
                const chatRef = doc(collection(db, 'chat'));
                await setDoc(chatRef, { user: userData.name, message, timestamp: new Date().toISOString(), uid: auth.currentUser.uid });
                document.getElementById('chatInput').value = '';
                if (!userData.challenges['challenge3']) completeChallenge('challenge3', 15);
            }
        };

        function loadChatMessages() {
            const messagesDiv = document.getElementById('chatMessages');
            onSnapshot(collection(db, 'chat'), snapshot => {
                messagesDiv.innerHTML = '';
                const messages = [];
                snapshot.forEach(doc => messages.push(doc.data()));
                messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `chat-message ${msg.uid === auth.currentUser.uid ? 'self' : ''}`;
                    div.innerHTML = `<span>${msg.user}: ${msg.message}</span><span>${new Date(msg.timestamp).toLocaleTimeString()}</span>`;
                    messagesDiv.appendChild(div);
                });
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }

        window.addResource = async function() {
            const title = document.getElementById('resourceTitle').value.trim();
            const url = document.getElementById('resourceUrl').value.trim();
            if (title && url) {
                const resourceList = document.getElementById('resourceList');
                const li = document.createElement('li');
                li.className = 'resource-item';
                li.innerHTML = `<span>${title}</span><a href="${url}" target="_blank">Visit</a>`;
                resourceList.appendChild(li);
                userData.resources = userData.resources || [];
                userData.resources.push({ title, url });
                localStorage.setItem('basudevUser', JSON.stringify(userData));
                await updateDoc(doc(db, 'users', auth.currentUser.uid), { resources: userData.resources });
                document.getElementById('resourceTitle').value = '';
                document.getElementById('resourceUrl').value = '';
            }
        };

        window.addGoal = async function() {
            const goal = document.getElementById('goalInput').value.trim();
            if (goal) {
                userData.goals.push({ text: goal, completed: false });
                localStorage.setItem('basudevUser', JSON.stringify(userData));
                await updateDoc(doc(db, 'users', auth.currentUser.uid), { goals: userData.goals });
                document.getElementById('goalInput').value = '';
                loadGoals();
            }
        };

        function loadGoals() {
            const goalList = document.getElementById('goalList');
            goalList.innerHTML = '';
            userData.goals.forEach((goal, index) => {
                const li = document.createElement('li');
                li.className = `goal-item ${goal.completed ? 'completed' : ''}`;
                li.innerHTML = `<span>${goal.text}</span><button onclick="toggleGoal(${index})">${goal.completed ? 'Undo' : 'Complete'}</button>`;
                goalList.appendChild(li);
            });
        }

        window.toggleGoal = async function(index) {
            userData.goals[index].completed = !userData.goals[index].completed;
            if (userData.goals[index].completed) userData.points += 10;
            localStorage.setItem('basudevUser', JSON.stringify(userData));
            await updateDoc(doc(db, 'users', auth.currentUser.uid), { goals: userData.goals, points: userData.points });
            document.getElementById('userPoints').textContent = userData.points;
            loadGoals();
        };

        function loadQuiz() {
            const questions = [
                { question: "What does HTML stand for?", options: ["Hyper Text Markup Language", "High Text Machine Language", "Hyper Tabular Markup Language", "None"], answer: 0 },
                { question: "Which CSS property sets text color?", options: ["font-size", "color", "background", "padding"], answer: 1 },
                { question: "What is JavaScript used for?", options: ["Styling", "Structure", "Interactivity", "Database"], answer: 2 }
            ];
            const today = new Date().toDateString();
            const quizIndex = Math.floor(new Date().getTime() / (1000 * 60 * 60 * 24)) % questions.length;
            const quiz = questions[quizIndex];
            document.getElementById('quizQuestion').textContent = quiz.question;
            const optionsDiv = document.getElementById('quizOptions');
            optionsDiv.innerHTML = '';
            quiz.options.forEach((option, i) => {
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'quizOption';
                input.value = i;
                input.id = `option${i}`;
                const label = document.createElement('label');
                label.htmlFor = `option${i}`;
                label.textContent = option;
                optionsDiv.appendChild(input);
                optionsDiv.appendChild(label);
            });
            userData.quiz = userData.quiz || {};
            userData.quiz[today] = userData.quiz[today] || { completed: false, score: 0 };
            if (userData.quiz[today].completed) {
                document.getElementById('quizResult').textContent = `Score: ${userData.quiz[today].score}/1`;
                document.querySelectorAll('#quizOptions input').forEach(input => input.disabled = true);
                document.querySelector('#quizCard button').disabled = true;
            }
        }

        window.submitQuiz = async function() {
            const selected = document.querySelector('input[name="quizOption"]:checked');
            if (!selected) return;
            const today = new Date().toDateString();
            const questions = [{ answer: 0 }, { answer: 1 }, { answer: 2 }];
            const quizIndex = Math.floor(new Date().getTime() / (1000 * 60 * 60 * 24)) % questions.length;
            const correct = parseInt(selected.value) === questions[quizIndex].answer;
            userData.quiz[today] = { completed: true, score: correct ? 1 : 0 };
            userData.points += correct ? 10 : 0;
            localStorage.setItem('basudevUser', JSON.stringify(userData));
            await updateDoc(doc(db, 'users', auth.currentUser.uid), { quiz: userData.quiz, points: userData.points });
            document.getElementById('quizResult').textContent = `Score: ${userData.quiz[today].score}/1 - ${correct ? 'Correct!' : 'Wrong!'}`;
            document.getElementById('userPoints').textContent = userData.points;
            document.querySelectorAll('#quizOptions input').forEach(input => input.disabled = true);
            document.querySelector('#quizCard button').disabled = true;
        };

        window.changeTheme = function() {
            const theme = document.getElementById('themeSelect').value;
            if (theme === 'light') {
                document.body.style.background = '#f0f0f0';
                document.body.style.color = '#0a0e1b';
                document.querySelector('.container').style.background = 'rgba(0, 0, 0, 0.05)';
                document.querySelectorAll('.card').forEach(card => card.style.background = 'rgba(255, 255, 255, 0.95)');
                document.querySelector('.nav-menu').style.background = 'rgba(255, 255, 255, 0.95)';
            } else if (theme === 'cosmic') {
                document.body.style.background = '#1a0033';
                document.body.style.color = '#e6ccff';
                document.querySelector('.container').style.background = 'rgba(230, 204, 255, 0.05)';
                document.querySelectorAll('.card').forEach(card => card.style.background = 'rgba(26, 0, 51, 0.95)');
                document.querySelector('.nav-menu').style.background = 'rgba(26, 0, 51, 0.95)';
            } else {
                document.body.style.background = '#0a0e1b';
                document.body.style.color = '#e0e0e0';
                document.querySelector('.container').style.background = 'rgba(255, 255, 255, 0.05)';
                document.querySelectorAll('.card').forEach(card => card.style.background = 'rgba(10, 14, 27, 0.95)');
                document.querySelector('.nav-menu').style.background = 'rgba(10, 14, 27, 0.95)';
            }
            userData.theme = theme;
            localStorage.setItem('basudevUser', JSON.stringify(userData));
            updateDoc(doc(db, 'users', auth.currentUser.uid), { theme: userData.theme });
        };

        window.changeEmail = function() {
            const newEmail = document.getElementById('newEmail').value.trim();
            const password = document.getElementById('emailPassword').value;
            const messageElement = document.getElementById('settingsMessage');
            if (!newEmail || !password) {
                messageElement.classList.add('error');
                messageElement.textContent = "Please enter both new email and password.";
                return;
            }
            showLoading();
            const credential = EmailAuthProvider.credential(auth.currentUser.email, password);
            reauthenticateWithCredential(auth.currentUser, credential).then(() => {
                updateEmail(auth.currentUser, newEmail).then(() => {
                    updateDoc(doc(db, 'users', auth.currentUser.uid), { email: newEmail }).then(() => {
                        hideLoading();
                        messageElement.classList.remove('error');
                        messageElement.textContent = "Email updated successfully! Verify your new email.";
                        document.getElementById('newEmail').value = '';
                        document.getElementById('emailPassword').value = '';
                    }).catch(error => {
                        hideLoading();
                        messageElement.classList.add('error');
                        messageElement.textContent = `Error updating email in Firestore: ${error.message}`;
                    });
                }).catch(error => {
                    hideLoading();
                    messageElement.classList.add('error');
                    messageElement.textContent = `Error updating email: ${error.message}`;
                });
            }).catch(error => {
                hideLoading();
                messageElement.classList.add('error');
                messageElement.textContent = `Re-authentication failed: ${error.message}`;
            });
        };

        window.changePassword = function() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const messageElement = document.getElementById('settingsMessage');
            if (!currentPassword || !newPassword) {
                messageElement.classList.add('error');
                messageElement.textContent = "Please enter both passwords.";
                return;
            }
            showLoading();
            const credential = EmailAuthProvider.credential(auth.currentUser.email, currentPassword);
            reauthenticateWithCredential(auth.currentUser, credential).then(() => {
                updatePassword(auth.currentUser, newPassword).then(() => {
                    hideLoading();
                    messageElement.classList.remove('error');
                    messageElement.textContent = "Password updated successfully!";
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                }).catch(error => {
                    hideLoading();
                    messageElement.classList.add('error');
                    messageElement.textContent = `Error updating password: ${error.message}`;
                });
            }).catch(error => {
                hideLoading();
                messageElement.classList.add('error');
                messageElement.textContent = `Re-authentication failed: ${error.message}`;
            });
        };

        window.updateUsername = function() {
            const newUsername = document.getElementById('newUsername').value.trim();
            const messageElement = document.getElementById('settingsMessage');
            if (!newUsername) {
                messageElement.classList.add('error');
                messageElement.textContent = "Please enter a new username.";
                return;
            }
            showLoading();
            updateDoc(doc(db, 'users', auth.currentUser.uid), { username: newUsername }).then(() => {
                userData.name = newUsername;
                userData.username = newUsername;
                localStorage.setItem('basudevUser', JSON.stringify(userData));
                document.getElementById('userNameDisplay').textContent = newUsername;
                hideLoading();
                messageElement.classList.remove('error');
                messageElement.textContent = "Username updated successfully!";
                document.getElementById('newUsername').value = '';
            }).catch(error => {
                hideLoading();
                messageElement.classList.add('error');
                messageElement.textContent = `Error updating username: ${error.message}`;
            });
        };

        window.deleteAccount = function() {
            const messageElement = document.getElementById('settingsMessage');
            if (!confirm("Are you sure you want to delete your account?")) return;
            showLoading();
            deleteUser(auth.currentUser).then(() => {
                deleteDoc(doc(db, 'users', auth.currentUser.uid)).then(() => {
                    hideLoading();
                    messageElement.classList.remove('error');
                    messageElement.textContent = "Account deleted successfully.";
                    setTimeout(redirectToLogin, 1000);
                }).catch(error => {
                    hideLoading();
                    messageElement.classList.add('error');
                    messageElement.textContent = `Error deleting user data: ${error.message}`;
                });
            }).catch(error => {
                hideLoading();
                messageElement.classList.add('error');
                messageElement.textContent = error.code === 'auth/requires-recent-login' ? "Please re-authenticate to delete your account." : `Error deleting account: ${error.message}`;
            });
        };

        async function initVideoCall() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('userRoomId').textContent = userData.roomId;
                listenForIncomingCall();
            } catch (error) {
                console.error("Error initializing video call:", error);
                document.getElementById('callStatus').textContent = "Error: Camera/microphone access denied.";
            }
        }

        function listenForIncomingCall() {
            const roomRef = doc(db, 'calls', userData.roomId);
            const offerCandidates = collection(roomRef, 'offerCandidates');
            const answerCandidates = collection(roomRef, 'answerCandidates');
            onSnapshot(roomRef, async snapshot => {
                const data = snapshot.data();
                if (data && data.offer && !peerConnection) await handleIncomingCall(roomRef, offerCandidates, answerCandidates);
            });
        }

        async function handleIncomingCall(roomRef, offerCandidates, answerCandidates) {
            peerConnection = new RTCPeerConnection(servers);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            peerConnection.onicecandidate = event => { if (event.candidate) addDoc(answerCandidates, event.candidate.toJSON()); };
            const data = (await getDoc(roomRef)).data();
            const offerDescription = new RTCSessionDescription(data.offer);
            await peerConnection.setRemoteDescription(offerDescription);
            const answerDescription = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answerDescription);
            await updateDoc(roomRef, { answer: { sdp: answerDescription.sdp, type: answerDescription.type } });
            onSnapshot(offerCandidates, snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                });
            });
            peerConnection.ontrack = event => {
                remoteStream = remoteStream || new MediaStream();
                event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
                document.getElementById('remoteVideo').srcObject = remoteStream;
                document.getElementById('callStatus').textContent = "Connected!";
                document.getElementById('hangupBtn').disabled = false;
                document.getElementById('callBtn').disabled = true;
            };
        }

        window.startCall = async function() {
            const remoteRoomId = document.getElementById('remoteRoomId').value.trim();
            if (!remoteRoomId) {
                document.getElementById('callStatus').textContent = "Enter a Room ID.";
                return;
            }
            if (remoteRoomId === userData.roomId) {
                document.getElementById('callStatus').textContent = "Cannot call your own Room ID.";
                return;
            }
            showLoading();
            document.getElementById('callBtn').disabled = true;
            peerConnection = new RTCPeerConnection(servers);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            const roomRef = doc(db, 'calls', remoteRoomId);
            const offerCandidates = collection(roomRef, 'offerCandidates');
            const answerCandidates = collection(roomRef, 'answerCandidates');
            peerConnection.onicecandidate = event => { if (event.candidate) addDoc(offerCandidates, event.candidate.toJSON()); };
            const offerDescription = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offerDescription);
            await setDoc(roomRef, { offer: { sdp: offerDescription.sdp, type: offerDescription.type } }, { merge: true });
            onSnapshot(roomRef, snapshot => {
                const data = snapshot.data();
                if (data && data.answer && !peerConnection.currentRemoteDescription) peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
            });
            onSnapshot(answerCandidates, snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                });
            });
            peerConnection.ontrack = event => {
                remoteStream = remoteStream || new MediaStream();
                event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
                document.getElementById('remoteVideo').srcObject = remoteStream;
                document.getElementById('callStatus').textContent = "Connected!";
                document.getElementById('hangupBtn').disabled = false;
            };
            document.getElementById('callStatus').textContent = `Calling ${remoteRoomId}...`;
            hideLoading();
        };

        window.hangUp = function() {
            if (peerConnection) peerConnection.close();
            peerConnection = null;
            if (remoteStream) remoteStream.getTracks().forEach(track => track.stop());
            remoteStream = null;
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            localStream = null;
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('callBtn').disabled = false;
            document.getElementById('hangupBtn').disabled = true;
            document.getElementById('remoteRoomId').value = '';
            document.getElementById('callStatus').textContent = `Your Room ID: ${userData.roomId}`;
            isVideoCallActive = false;
        };

        window.searchBooks = async function() {
            const query = document.getElementById('bookSearch').value.trim();
            if (!query) {
                document.getElementById('ebookMessage').textContent = "Enter a search term.";
                return;
            }
            showLoading();
            try {
                const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&key=${GOOGLE_BOOKS_API_KEY}&maxResults=10`);
                const data = await response.json();
                hideLoading();
                if (data.items) {
                    displayBooks(data.items);
                    document.getElementById('ebookMessage').textContent = `Found ${data.items.length} books!`;
                } else {
                    document.getElementById('bookList').innerHTML = '';
                    document.getElementById('ebookMessage').textContent = "No books found.";
                }
            } catch (error) {
                hideLoading();
                console.error("Error searching books:", error);
                document.getElementById('ebookMessage').textContent = "Error searching books.";
            }
        };

        function displayBooks(books) {
            const bookList = document.getElementById('bookList');
            bookList.innerHTML = '';
            books.forEach(book => {
                const volumeInfo = book.volumeInfo;
                const bookId = book.id;
                const title = volumeInfo.title || "Unknown Title";
                const authors = volumeInfo.authors ? volumeInfo.authors.join(", ") : "Unknown Author";
                const description = volumeInfo.description ? volumeInfo.description.substring(0, 100) + "..." : "No description.";
                const thumbnail = volumeInfo.imageLinks ? volumeInfo.imageLinks.thumbnail : "https://via.placeholder.com/80x120?text=No+Image";
                const bookItem = document.createElement('div');
                bookItem.className = 'book-item';
                bookItem.innerHTML = `<img src="${thumbnail}" alt="${title}"><div class="book-info"><h3>${title}</h3><p><strong>Author:</strong> ${authors}</p><p>${description}</p></div><button onclick="addToFavorites('${bookId}', '${title}', '${authors}', '${thumbnail}')">Add to Favorites</button>`;
                bookList.appendChild(bookItem);
            });
        }

        window.addToFavorites = async function(bookId, title, authors, thumbnail) {
            if (!userData.favoriteBooks.some(book => book.id === bookId)) {
                userData.favoriteBooks.push({ id: bookId, title, authors, thumbnail });
                localStorage.setItem('basudevUser', JSON.stringify(userData));
                await updateDoc(doc(db, 'users', auth.currentUser.uid), { favoriteBooks: userData.favoriteBooks });
                document.getElementById('ebookMessage').textContent = `${title} added to favorites!`;
                loadFavoriteBooks();
            } else {
                document.getElementById('ebookMessage').textContent = `${title} already in favorites!`;
            }
        };

        function loadFavoriteBooks() {
            const favoriteBooksDiv = document.getElementById('favoriteBooks');
            favoriteBooksDiv.innerHTML = userData.favoriteBooks.length === 0 ? '<p>No favorite books yet.</p>' : '';
            userData.favoriteBooks.forEach(book => {
                const bookItem = document.createElement('div');
                bookItem.className = 'book-item';
                bookItem.innerHTML = `<img src="${book.thumbnail}" alt="${book.title}"><div class="book-info"><h3>${book.title}</h3><p><strong>Author:</strong> ${book.authors}</p></div><button onclick="removeFromFavorites('${book.id}')">Remove</button>`;
                favoriteBooksDiv.appendChild(bookItem);
            });
        }

        window.removeFromFavorites = async function(bookId) {
            userData.favoriteBooks = userData.favoriteBooks.filter(book => book.id !== bookId);
            localStorage.setItem('basudevUser', JSON.stringify(userData));
            await updateDoc(doc(db, 'users', auth.currentUser.uid), { favoriteBooks: userData.favoriteBooks });
            document.getElementById('ebookMessage').textContent = "Book removed from favorites.";
            loadFavoriteBooks();
        };

        window.searchYouTube = async function() {
            const query = document.getElementById('youtubeSearch').value.trim();
            if (!query) {
                document.getElementById('youtubeMessage').textContent = "Enter a search term.";
                return;
            }
            showLoading();
            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&maxResults=10&key=${YOUTUBE_API_KEY}`);
                const data = await response.json();
                hideLoading();
                if (data.items) {
                    displayYouTubeVideos(data.items);
                    document.getElementById('youtubeMessage').textContent = `Found ${data.items.length} videos!`;
                } else {
                    document.getElementById('youtubeList').innerHTML = '';
                    document.getElementById('youtubeMessage').textContent = "No videos found.";
                }
            } catch (error) {
                hideLoading();
                console.error("Error searching YouTube:", error);
                document.getElementById('youtubeMessage').textContent = "Error searching videos.";
            }
        };

        function displayYouTubeVideos(videos) {
            const youtubeList = document.getElementById('youtubeList');
            youtubeList.innerHTML = '';
            videos.forEach(video => {
                const videoId = video.id.videoId;
                const title = video.snippet.title || "Unknown Title";
                const thumbnail = video.snippet.thumbnails.medium.url || "https://via.placeholder.com/120x90?text=No+Image";
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item';
                videoItem.innerHTML = `<img src="${thumbnail}" alt="${title}"><div class="video-info"><h3>${title}</h3></div><button onclick="addToFavoriteVideos('${videoId}', '${title}', '${thumbnail}')">Add to Favorites</button>`;
                youtubeList.appendChild(videoItem);
            });
        }

        window.addToFavoriteVideos = async function(videoId, title, thumbnail) {
            if (!userData.favoriteVideos.some(video => video.id === videoId)) {
                userData.favoriteVideos.push({ id: videoId, title, thumbnail });
                localStorage.setItem('basudevUser', JSON.stringify(userData));
                await updateDoc(doc(db, 'users', auth.currentUser.uid), { favoriteVideos: userData.favoriteVideos });
                document.getElementById('youtubeMessage').textContent = `${title} added to favorites!`;
                loadFavoriteVideos();
            } else {
                document.getElementById('youtubeMessage').textContent = `${title} already in favorites!`;
            }
        };

        function loadFavoriteVideos() {
            const favoriteVideosDiv = document.getElementById('favoriteVideos');
            favoriteVideosDiv.innerHTML = userData.favoriteVideos.length === 0 ? '<p>No favorite videos yet.</p>' : '';
            userData.favoriteVideos.forEach(video => {
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item';
                videoItem.innerHTML = `<img src="${video.thumbnail}" alt="${video.title}"><div class="video-info"><h3>${video.title}</h3></div><button onclick="removeFromFavoriteVideos('${video.id}')">Remove</button>`;
                favoriteVideosDiv.appendChild(videoItem);
            });
        }

        window.removeFromFavoriteVideos = async function(videoId) {
            userData.favoriteVideos = userData.favoriteVideos.filter(video => video.id !== videoId);
            localStorage.setItem('basudevUser', JSON.stringify(userData));
            await updateDoc(doc(db, 'users', auth.currentUser.uid), { favoriteVideos: userData.favoriteVideos });
            document.getElementById('youtubeMessage').textContent = "Video removed from favorites.";
            loadFavoriteVideos();
        };

        function initializeDashboard() {
            document.getElementById('userNameDisplay').textContent = userData.name;
            document.getElementById('avatar').src = userData.avatar || defaultAvatar;
            document.getElementById('lastLogin').textContent = userData.lastLogin || "Just Now";
            document.getElementById('daysActive').textContent = userData.loginCount;
            document.getElementById('streakCount').textContent = userData.streak;
            document.getElementById('streakCircle').textContent = userData.streak;
            document.getElementById('notes').value = userData.notes;
            document.getElementById('userPoints').textContent = userData.points;
            document.getElementById('userBio').textContent = userData.bio;
            document.getElementById('userRoomId').textContent = userData.roomId;
            if (userData.theme) {
                document.getElementById('themeSelect').value = userData.theme;
                changeTheme();
            }
            loadProgress();
            updateChallengeStatus();
            loadFavoriteBooks();
            loadFavoriteVideos();
        }

        onAuthStateChanged(auth, (user) => {
            if (user) initializeDashboard();
        });
    </script>
</body>
</html>
